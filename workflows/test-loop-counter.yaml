version: 2
metadata:
  name: Counter Loop Test
  description: Simple loop that counts up to a target number (shell nodes only)

nodes:
  - id: trigger
    type: trigger
    position: { x: 100, y: 100 }
    data:
      nodeType: trigger
      label: Start
      triggerType: manual
      outputs:
        - name: timestamp
          type: string
        - name: type
          type: string
        - name: text
          type: string
        - name: params
          type: json

  - id: count-loop
    type: loop
    position: { x: 300, y: 100 }
    style: { width: 600, height: 400 }
    data:
      label: Count to Target
      nodeType: loop
      maxIterations: 10
      inputs:
        - name: target
          type: string
          default: "5"
      outputs:
        - name: final_count
          type: number

  # Child nodes - these belong to count-loop via parentId
  - id: loop-input
    type: interface-input
    parentId: count-loop
    extent: parent
    position: { x: 20, y: 50 }
    data:
      nodeType: interface-input
      label: Input
      outputs:
        - name: target
          type: string
        - name: iteration
          type: number
        - name: prev.count
          type: number

  - id: loop-output
    type: interface-output
    parentId: count-loop
    extent: parent
    position: { x: 400, y: 50 }
    data:
      nodeType: interface-output
      label: Output
      inputs:
        - name: count
          type: number

  - id: loop-continue
    type: interface-continue
    parentId: count-loop
    extent: parent
    position: { x: 400, y: 200 }
    data:
      nodeType: interface-continue
      label: Continue?
      inputs:
        - name: continue
          type: boolean

  - id: counter
    type: shell
    parentId: count-loop
    extent: parent
    position: { x: 180, y: 100 }
    data:
      nodeType: shell
      label: Increment Counter
      script: |
        TARGET={{ inputs.target }}
        PREV={{ inputs.prev_count }}
        PREV=${PREV:-0}
        # Handle null/empty prev value
        if [ "$PREV" = "null" ] || [ -z "$PREV" ]; then
          PREV=0
        fi
        COUNT=$((PREV + 1))
        echo "Count: $COUNT / $TARGET"
        if [ $COUNT -lt $TARGET ]; then
          echo "CONTINUE=true"
        else
          echo "CONTINUE=false"
        fi
      inputs:
        - name: target
          type: string
        - name: prev_count
          type: number
      outputs:
        - name: count
          type: number
          extract:
            type: regex
            pattern: 'Count: (\d+)'
        - name: should_continue
          type: boolean
          extract:
            type: regex
            pattern: 'CONTINUE=(true|false)'

edges:
  # Outer edge: Trigger -> Loop
  - id: trigger-to-loop
    source: trigger
    target: count-loop
    sourceHandle: "output:text"
    targetHandle: "input:target"

  # Inner edges (within the loop)
  - id: e1
    source: loop-input
    target: counter
    sourceHandle: "output:target"
    targetHandle: "input:target"

  - id: e2
    source: loop-input
    target: counter
    sourceHandle: "output:prev.count"
    targetHandle: "input:prev_count"

  - id: e3
    source: counter
    target: loop-output
    sourceHandle: "output:count"
    targetHandle: "input:count"

  - id: e4
    source: counter
    target: loop-continue
    sourceHandle: "output:should_continue"
    targetHandle: "input:continue"
