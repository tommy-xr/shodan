version: 3
metadata:
  name: Test Nested Inline Components
  description: Tests inline component that uses another inline component

# Inline component definitions
components:
  # Simple uppercase component
  uppercase:
    interface:
      inputs:
        - name: text
          type: string
      outputs:
        - name: result
          type: string
    nodes:
      - id: input-proxy
        type: interface-input
        position: { x: 100, y: 100 }
        data:
          nodeType: interface-input
          label: Input
          outputs:
            - name: text
              type: string
      - id: transform
        type: shell
        position: { x: 300, y: 100 }
        data:
          nodeType: shell
          label: Uppercase
          script: echo "{{ inputs.text }}" | tr '[:lower:]' '[:upper:]'
          inputs:
            - name: input
              type: any
            - name: text
              type: string
          outputs:
            - name: output
              type: string
            - name: stdout
              type: string
            - name: stderr
              type: string
            - name: exitCode
              type: number
      - id: output-proxy
        type: interface-output
        position: { x: 500, y: 100 }
        data:
          nodeType: interface-output
          label: Output
          inputs:
            - name: result
              type: string
    edges:
      - id: u-e1
        source: input-proxy
        target: transform
        sourceHandle: output:text
        targetHandle: input:text
      - id: u-e2
        source: transform
        target: output-proxy
        sourceHandle: output:stdout
        targetHandle: input:result

  # Wrapper component that uses uppercase and adds exclamation
  shout:
    interface:
      inputs:
        - name: text
          type: string
      outputs:
        - name: result
          type: string
    nodes:
      - id: input-proxy
        type: interface-input
        position: { x: 100, y: 100 }
        data:
          nodeType: interface-input
          label: Input
          outputs:
            - name: text
              type: string
      # Uses the uppercase inline component
      - id: upper
        type: component
        position: { x: 250, y: 100 }
        data:
          nodeType: component
          label: Uppercase
          componentRef: uppercase  # Reference to sibling inline component
          inputs:
            - name: text
              type: string
          outputs:
            - name: result
              type: string
      - id: add-exclaim
        type: shell
        position: { x: 400, y: 100 }
        data:
          nodeType: shell
          label: Add Exclamation
          script: echo "{{ inputs.text }}!!!"
          inputs:
            - name: input
              type: any
            - name: text
              type: string
          outputs:
            - name: output
              type: string
            - name: stdout
              type: string
            - name: stderr
              type: string
            - name: exitCode
              type: number
      - id: output-proxy
        type: interface-output
        position: { x: 550, y: 100 }
        data:
          nodeType: interface-output
          label: Output
          inputs:
            - name: result
              type: string
    edges:
      - id: s-e1
        source: input-proxy
        target: upper
        sourceHandle: output:text
        targetHandle: input:text
      - id: s-e2
        source: upper
        target: add-exclaim
        sourceHandle: output:result
        targetHandle: input:text
      - id: s-e3
        source: add-exclaim
        target: output-proxy
        sourceHandle: output:stdout
        targetHandle: input:result

# Main workflow nodes
nodes:
  - id: trigger
    type: trigger
    position: { x: 100, y: 100 }
    data:
      nodeType: trigger
      label: Start
      triggerType: manual
      outputs:
        - name: text
          type: string
        - name: timestamp
          type: string
        - name: type
          type: string
        - name: params
          type: json

  - id: component-shout
    type: component
    position: { x: 300, y: 100 }
    data:
      nodeType: component
      label: Shout
      componentRef: shout  # Uses the nested inline component
      inputs:
        - name: text
          type: string
      outputs:
        - name: result
          type: string

  - id: print
    type: shell
    position: { x: 500, y: 100 }
    data:
      nodeType: shell
      label: Print Result
      script: |
        echo "Original: {{ inputs.original }}"
        echo "Shouted: {{ inputs.shouted }}"
      inputs:
        - name: input
          type: any
        - name: original
          type: string
        - name: shouted
          type: string
      outputs:
        - name: output
          type: string
        - name: stdout
          type: string
        - name: stderr
          type: string
        - name: exitCode
          type: number

edges:
  - id: e1
    source: trigger
    target: component-shout
    sourceHandle: output:text
    targetHandle: input:text
  - id: e2
    source: trigger
    target: print
    sourceHandle: output:text
    targetHandle: input:original
  - id: e3
    source: component-shout
    target: print
    sourceHandle: output:result
    targetHandle: input:shouted
